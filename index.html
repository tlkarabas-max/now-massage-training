<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NOW Massage - Schedule Optimization Training (Upgraded)</title>
    <style>
        /* Existing styles ... */
        .solution-highlight {
            box-shadow: 0 0 0 3px #3866e6 inset, 0 0 12px #3866e6;
            border-radius: 8px;
            font-weight: bold;
            z-index: 2;
        }
        .btn:disabled, .btn[disabled] {
            background: #e0e0e0;
            color: #aaa;
            cursor: not-allowed;
            opacity: 0.7;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ...header and tabs as previously... -->

        <!-- PRACTICE SCENARIOS -->
        <div id="scenarios" class="content">
            <!-- ...directions and controls... -->
        </div>

        <!-- SCHEDULE SIMULATOR -->
        <div id="simulator" class="content">
            <!-- ...directions and controls... -->
            <div id="addMassagePanel" style="margin-bottom:24px;">
                <strong>Add Massage:</strong>
                <div style="display:flex; gap:10px; margin-top:8px;">
                    <div class="time-slot booked-80" draggable="true" ondragstart="dragStart(event)" data-type="booked_80">80m</div>
                    <div class="time-slot booked-50" draggable="true" ondragstart="dragStart(event)" data-type="booked_50">50m</div>
                </div>
            </div>
            <div class="schedule-grid" id="scheduleGrid"></div>
            <div class="score-panel">
                <!-- ...score/stat cards as previously... -->
            </div>
            <div class="stat-card">
                <div class="stat-value" id="utilizationRate">0%</div>
                <div class="stat-label">Utilization Rate</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="gapCount">0</div>
                <div class="stat-label">Gaps</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="optimalPatterns">0</div>
                <div class="stat-label">Optimal Patterns</div>
            </div>
            <!-- ...displaced appointments box, hint box... -->
            <div class="controls">
                <button class="btn btn-secondary" onclick="showHint()">Hint</button>
                <button id="showSolutionBtn" class="btn btn-primary" onclick="showSolution()" disabled>Show Solution</button>
                <button class="btn btn-secondary" onclick="nextSimulatorScenario()">Next Scenario</button>
            </div>
        </div>
        <!-- ...rest of your tabs... -->
    </div>
<script>
/* ---- CONFIG ---- */
const BUSINESS_HOURS = {
  sunday:    { open: "9:00", close: "20:00" },
  monday:    { open: "9:00", close: "20:00" },
  tuesday:   { open: "9:00", close: "20:00" },
  wednesday: { open: "9:00", close: "20:00" },
  thursday:  { open: "9:00", close: "20:00" },
  friday:    { open: "9:00", close: "21:00" },
  saturday:  { open: "9:00", close: "21:00" }
};
const BLOCK_TYPES = {
    "booked_80": {label: "80m", colorclass: "booked-80"},
    "booked_50": {label: "50m", colorclass: "booked-50"},
    "gap": {label: "GAP", colorclass: "gap"},
    "open": {label: "OPEN", colorclass: "open"},
    "break": {label: "Break", colorclass: "break"},
    "lunch": {label: "Lunch", colorclass: "lunch"},
    "callout": {label: "Call-out", colorclass: "callout"},
    "shift_adj": {label: "Shift Adj.", colorclass: "callout"},
    "requested_off": {label: "Req. Off", colorclass: "lunch"}
};

/* ---- Generate Time Slot Array ---- */
function generateTimeSlots(day) {
    let times = [];
    let hours = BUSINESS_HOURS[day];
    let [openH, openM] = hours.open.split(':').map(Number);
    let [closeH, closeM] = hours.close.split(':').map(Number);
    let dt = new Date(2020,0,1,openH,openM);
    let end = new Date(2020,0,1,closeH,closeM);
    while(dt < end) {
        let s = dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
        times.push(s);
        dt.setMinutes(dt.getMinutes()+30);
    }
    return times;
}

/* ---- Realistic Therapist Lists for Each Day ---- */
const THERAPISTS_REAL = {
  sunday: ["Aaron", "Amy", "Bill", "Gaia", "Hank", "Marti", "Seydonia", "Spencer", "Trang", "Alexis", "Jose", "Crawford"],
  monday: ["Amy", "Bill", "Frankie", "Marti", "Trang", "Vicente", "Victor", "Hank", "Jose", "Alexis", "Diaz", "Gaia", "Jayna", "Jon", "Sean"],
  tuesday: ["Jayna", "Jose", "Yari", "Carl", "Ryan", "Alexis", "Seydonia", "Hank", "Victor", "Aaron"],
  wednesday: ["Amy", "Jayna", "Spencer", "Trang", "Alexis", "Hank", "Bill", "Corey", "Diaz", "Frankie", "Yari"]
};

/* ---- Real-Life and Mixed Scenarios (some same, some different) ---- */
// ...ALL_SCENARIOS as before...

const DAY_LIST = Object.keys(BUSINESS_HOURS);
function capitalize(str) {return str.charAt(0).toUpperCase()+str.slice(1);}
function showTab(tab){
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
    document.querySelector(`[onclick="showTab('${tab}')"]`).classList.add('active');
    document.getElementById(tab).classList.add('active');
    if(tab==="scenarios")renderScenarioControls();
    if(tab==="simulator")renderSimulatorControls();
}
function renderScenarioControls(){
    let daySel=document.getElementById('scenarioDay');
    let scenSel=document.getElementById('scenarioNum');
    daySel.innerHTML=DAY_LIST.map(d=>`<option value="${d}">${capitalize(d)}</option>`).join('');
    let scens=ALL_SCENARIOS[DAY_LIST[0]];
    scenSel.innerHTML=scens.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
    daySel.onchange=function(){
        let scens=ALL_SCENARIOS[daySel.value];
        scenSel.innerHTML=scens.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
    };
}
function loadPracticeScenario(){
    let day=document.getElementById('scenarioDay').value;
    let idx=+document.getElementById('scenarioNum').value;
    let scenario=ALL_SCENARIOS[day][idx];
    let box=document.getElementById('practiceScenarioBox');
    box.innerHTML=`
        <h3>${scenario.name}</h3>
        <div>${scenario.description}</div>
        <div class="hint-box"><strong>Optimal Solution:</strong><br>${scenario.correctMoves.join('<br>')}</div>
        <div style="background:#ffe4c2;border-radius:8px;padding:10px;margin-top:8px;"><strong>Avoid:</strong><br>${scenario.incorrectMoves.join('<br>')}</div>
    `;
}
function renderSimulatorControls(){
    let daySel=document.getElementById('simDay');
    let scenSel=document.getElementById('simScenario');
    daySel.innerHTML=DAY_LIST.map(d=>`<option value="${d}">${capitalize(d)}</option>`).join('');
    let scens=ALL_SCENARIOS[DAY_LIST[0]];
    scenSel.innerHTML=scens.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
    daySel.onchange=function(){
        let scens=ALL_SCENARIOS[daySel.value];
        scenSel.innerHTML=scens.map((s,i)=>`<option value="${i}">${s.name}</option>`).join('');
    };
}
let moves=0;
let userAttempts=0;
let solutionShown=false;
function registerUserAttempt() {
    userAttempts++;
    updateShowSolutionButton();
}
function loadSimulatorScenario(){
    let day=document.getElementById('simDay').value;
    let idx=+document.getElementById('simScenario').value;
    let scenario=ALL_SCENARIOS[day][idx];
    renderScheduleGrid(day,scenario);
    moves=0;
    userAttempts=0;
    solutionShown=false;
    document.getElementById('movesCount').textContent=moves;
    updateShowSolutionButton();
    removeSolutionHighlights();
    hideHint();
}
function clearSchedule(){
    let day=document.getElementById('simDay').value;
    let times=generateTimeSlots(day);
    let grid=document.getElementById('scheduleGrid');
    let therapists=THERAPISTS_REAL[day];
    grid.innerHTML='';
    grid.innerHTML+=`<div class="time-slot header">Time</div>`;
    therapists.forEach(t=>grid.innerHTML+=`<div class="time-slot header">${t}</div>`);
    for(let t=0;t<times.length;t++){
        grid.innerHTML+=`<div class="time-slot time-header">${times[t]}</div>`;
        for(let i=0;i<therapists.length;i++){
            grid.innerHTML+=`<div class="time-slot open" data-type="open" data-tidx="${i}" data-time="${times[t]}" data-slot-id="${t+'-'+i}" draggable="true" ondragstart="slotDragStart(event)" ondragover="allowDrop(event)" ondrop="dropSlot(event)" onclick="toggleSlot(this)"></div>`;
        }
    }
    moves=0;
    userAttempts=0;
    solutionShown=false;
    updateShowSolutionButton();
    removeSolutionHighlights();
}
function nextSimulatorScenario(){
    let daySel=document.getElementById('simDay');
    let scenSel=document.getElementById('simScenario');
    let day=daySel.value;
    let idx=+scenSel.value;
    let scens=ALL_SCENARIOS[day];
    idx=(idx+1)%scens.length;
    scenSel.value=idx;
    loadSimulatorScenario();
}
function showHint(){
    let box=document.getElementById('hintBox');
    box.style.display="block";
    box.textContent="Tip: Drag appointments to fill gaps, focus on late day coverage!";
}
function hideHint(){
    let box=document.getElementById('hintBox');
    box.style.display="none";
}
function updateShowSolutionButton() {
    const btn = document.getElementById('showSolutionBtn');
    btn.disabled = userAttempts < 2;
}
function showSolution() {
    if (userAttempts < 2) return;
    solutionShown = true;
    highlightSolutionCells();
}
function highlightSolutionCells() {
    removeSolutionHighlights();
    // Get current scenario
    let day = document.getElementById('simDay').value;
    let idx = +document.getElementById('simScenario').value;
    let scenario = ALL_SCENARIOS[day][idx];
    // Highlight logic (hybrid: simple for easy, scenario-specific for hard)
    scenario.schedule.forEach((therapistBlock, colIdx) => {
        therapistBlock.slots.forEach((slotType, rowIdx) => {
            if (isOptimalCell(slotType, rowIdx, colIdx, therapistBlock, scenario)) {
                let slotEl = document.querySelector(`[data-slot-id="${rowIdx+'-'+colIdx}"]`);
                if (slotEl) slotEl.classList.add('solution-highlight');
            }
        });
    });
}
function removeSolutionHighlights() {
    document.querySelectorAll('.solution-highlight').forEach(el => el.classList.remove('solution-highlight'));
}

// Logic for "solution" cells. You can expand this as needed.
function isOptimalCell(slotType, rowIdx, colIdx, therapistBlock, scenario) {
    // Simple logic: highlight booked_80, filled gaps
    if (scenario.name.toLowerCase().includes("easy") || scenario.name.toLowerCase().includes("different case")) {
        return slotType === 'booked_80' || slotType === 'gap' && rowIdx > 12; // gaps late day
    }
    // Intermediate: highlight staggered breaks/lunches (no overlap)
    if (scenario.name.toLowerCase().includes("lunch wave")) {
        // Check if this break/lunch is not overlapping (max 1 lunch per time)
        let count = 0;
        scenario.schedule.forEach(tb => {
            if (tb.slots[rowIdx] === "lunch") count++;
        });
        return slotType === "lunch" && count === 1;
    }
    // Advanced: scenario-specific, e.g. callouts, shift, late day bookings
    if (scenario.name.toLowerCase().includes("callout")) {
        return slotType === "booked_80" && rowIdx > 15 || slotType === "callout";
    }
    // Default: booked_80, filled gaps
    return slotType === 'booked_80';
}

/* ---- Drag-and-Drop Logic ---- */
let draggedType=null;
let draggedSlot=null;
function dragStart(e){
    draggedType=e.target.dataset.type;
    draggedSlot=null;
    e.dataTransfer.effectAllowed="move";
}
function allowDrop(e){e.preventDefault();}
function dropSlot(e){
    e.preventDefault();
    let slot=e.target;
    if(draggedType){
        slot.dataset.type=draggedType;
        slot.className="time-slot "+(BLOCK_TYPES[draggedType]?.colorclass||"");
        slot.textContent=BLOCK_TYPES[draggedType]?.label||"";
        moves++;
        registerUserAttempt();
        document.getElementById('movesCount').textContent=moves;
        hideHint();
        draggedType=null;
        draggedSlot=null;
        updateScheduleStats();
        return;
    }
    if(draggedSlot){
        let fromSlot=document.querySelector(`[data-slot-id='${draggedSlot}']`);
        let tempType=slot.dataset.type;
        let tempLabel=slot.textContent;
        let tempClass=slot.className;
        slot.dataset.type=fromSlot.dataset.type;
        slot.className=fromSlot.className;
        slot.textContent=fromSlot.textContent;
        fromSlot.dataset.type=tempType;
        fromSlot.className=tempClass;
        fromSlot.textContent=tempLabel;
        moves++;
        registerUserAttempt();
        document.getElementById('movesCount').textContent=moves;
        hideHint();
        draggedType=null;
        draggedSlot=null;
        updateScheduleStats();
        return;
    }
}
function slotDragStart(e){
    draggedType=e.target.dataset.type;
    draggedSlot=e.target.dataset.slotId;
    e.dataTransfer.effectAllowed="move";
}
/* ---- Click to cycle slot type ---- */
const CYCLE_TYPES=["open","booked_80","booked_50","gap","break","lunch","callout","shift_adj","requested_off"];
function toggleSlot(slot){
    let cur=slot.dataset.type||"open";
    let idx=CYCLE_TYPES.indexOf(cur);
    let nextType=CYCLE_TYPES[(idx+1)%CYCLE_TYPES.length];
    slot.dataset.type=nextType;
    slot.className="time-slot "+(BLOCK_TYPES[nextType]?.colorclass||"");
    slot.textContent=BLOCK_TYPES[nextType]?.label||"";
    moves++;
    registerUserAttempt();
    document.getElementById('movesCount').textContent=moves;
    hideHint();
    updateScheduleStats();
}
/* ---- Render Schedule Grid ---- */
function renderScheduleGrid(day,scenario){
    let times=generateTimeSlots(day);
    let grid=document.getElementById('scheduleGrid');
    let therapists=scenario.therapists;
    grid.innerHTML='';
    grid.innerHTML+=`<div class="time-slot header">Time</div>`;
    therapists.forEach(t=>grid.innerHTML+=`<div class="time-slot header">${t}</div>`);
    let slotId=0;
    for(let t=0;t<times.length;t++){
        grid.innerHTML+=`<div class="time-slot time-header">${times[t]}</div>`;
        for(let i=0;i<therapists.length;i++){
            let type=(scenario.schedule[i]&&scenario.schedule[i].slots[t])||'open';
            let block=BLOCK_TYPES[type]||{label:"",colorclass:""};
            grid.innerHTML+=`<div class="time-slot ${block.colorclass}" data-type="${type}" data-tidx="${i}" data-time="${times[t]}" data-slot-id="${t+'-'+i}" draggable="true" ondragstart="slotDragStart(event)" ondragover="allowDrop(event)" ondrop="dropSlot(event)" onclick="toggleSlot(this)">${block.label||""}</div>`;
            slotId++;
        }
    }
    updateScheduleStats();
    removeSolutionHighlights();
}
/* ---- Schedule Stats ---- */
function updateScheduleStats(){
    let slots=document.querySelectorAll('.schedule-grid .time-slot:not(.header):not(.time-header)');
    let booked=0,gaps=0,open=0,optimal=0;
    slots.forEach(s=>{
        let type=s.dataset.type;
        if(type==="open")open++;
        if(type==="gap")gaps++;
        if(type&&type.startsWith("booked"))booked++;
        if(type==="booked_80"||type==="booked_50")optimal++;
    });
    let total=slots.length;
    let utilization=Math.round(100*booked/total);
    document.getElementById('utilizationRate').textContent=utilization+"%";
    document.getElementById('gapCount').textContent=gaps;
    document.getElementById('optimalPatterns').textContent=optimal;
    document.getElementById('gapsFixedCount').textContent=gaps===0?"All":(total-gaps);
    document.getElementById('revenueSaved').textContent="$"+(booked*120);
    document.getElementById('gradeValue').textContent=utilization>80&&gaps===0?"A":utilization>70?"B":"C";
}
/* ---- INIT ---- */
window.onload=function(){
    showTab('overview');
    renderScenarioControls();
    renderSimulatorControls();
    updateShowSolutionButton();
};
</script>
</body>
</html>
